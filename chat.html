<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="dark light" />
  <title>üí¨ 3DVR Group Chat</title>
  <link rel="icon" href="3DVRfavicon.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Poppins:wght@600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <style>
    :root {
      --accent: #00ffc8;
      --bg: linear-gradient(135deg, #1e2a38, #2c3e50);
      --sidebar-bg: rgba(255, 255, 255, 0.04);
      --card-bg: rgba(255, 255, 255, 0.06);
      --text: #ffffff;
      --text-secondary: #cccccc;
      --border-radius: 12px;
      --transition: all 0.3s ease;
      --message-bg: rgba(255, 255, 255, 0.08);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .top-buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
      padding: 0.8rem 1rem;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .top-buttons a {
      color: var(--text);
      text-decoration: none;
      font-size: 0.95rem;
      font-weight: 600;
      padding: 0.4rem 0.8rem;
      border-radius: var(--border-radius);
      background: rgba(255, 255, 255, 0.1);
      transition: var(--transition);
    }

    .top-buttons a:hover {
      background: var(--accent);
      color: #000;
    }

    header {
      text-align: center;
      padding: 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    header h1 {
      font-family: 'Poppins', sans-serif;
      font-size: clamp(1.8rem, 5vw, 2.5rem);
      margin-bottom: 0.5rem;
    }

    header p {
      color: var(--accent);
      font-size: 1rem;
    }

    .container {
      display: flex;
      flex: 1;
      height: calc(100vh - 140px);
      overflow: hidden;
    }

    .sidebar {
      width: 240px;
      background: var(--sidebar-bg);
      padding: 1.5rem;
      border-right: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .sidebar h3 {
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      color: var(--accent);
      margin-bottom: 0.5rem;
    }

    .room-select select {
      width: 100%;
      padding: 0.6rem;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: var(--text);
      font-size: 0.95rem;
    }

    .profile-mini {
      background: var(--card-bg);
      padding: 1rem;
      border-radius: var(--border-radius);
      font-size: 0.95rem;
    }

    .profile-mini input {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.5rem;
      border-radius: 6px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
    }

    .profile-mini button {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.5rem;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.95rem;
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column-reverse;
    }

    .message {
      background: var(--message-bg);
      border-radius: 12px;
      padding: 0.8rem 1rem;
      margin-bottom: 0.8rem;
      max-width: 80%;
      align-self: flex-start;
      font-size: 1rem;
      position: relative;
    }

    .message.sent {
      align-self: flex-end;
      background: rgba(0, 255, 200, 0.15);
    }

    .message strong {
      color: var(--accent);
    }

    .message .meta {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 0.4rem;
    }

    .message .attachment {
      margin-top: 0.5rem;
      border-radius: 8px;
      overflow: hidden;
    }

    .message .attachment img {
      max-width: 180px;
      border-radius: 6px;
    }

    #new-message {
      display: flex;
      gap: 0.5rem;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.2);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    #message-input {
      flex: 1;
      padding: 0.8rem;
      border-radius: 8px;
      border: none;
      background: var(--card-bg);
      color: var(--text);
      font-size: 1rem;
    }

    #message-input:focus {
      outline: 2px solid var(--accent);
    }

    #send-btn, #upload-btn {
      padding: 0.8rem 1.2rem;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }

    #upload-btn {
      position: relative;
      overflow: hidden;
    }

    #upload-btn input {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    footer {
      padding: 1rem;
      text-align: center;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    footer a {
      color: var(--accent);
      text-decoration: none;
    }
  </style>
</head>
<body>

  <div class="top-buttons">
    <a href="index.html">üè† Portal Home</a>
    <a href="profile.html">üßë Profile</a>
    <a href="https://3dvr.tech/#subscribe" target="_blank">‚≠ê Subscribe</a>
    <a href="https://github.com/tmsteph/3dvr-portal" target="_blank">üöÄ Contribute on GitHub</a>
  </div>

  <header>
    <h1>Group Chat</h1>
    <p>üí¨ You earn <strong>+1 point</strong> for every message you send!</p>
  </header>

  <div class="container">
    <aside class="sidebar">
      <div class="room-select">
        <h3>üí¨ Select Room</h3>
        <select id="room" onchange="changeRoom()">
          <option value="general">üåé General</option>
          <option value="ideas">üí° Ideas</option>
          <option value="support">üõü Support</option>
          <option value="random">üé≤ Random</option>
          <option value="tasks">‚úÖ Tasks</option>
        </select>
      </div>

      <div class="profile-mini">
        <p><strong>Username:</strong> <span id="current-username">Loading...</span></p>
        <input type="text" id="new-username" placeholder="New username...">
        <button onclick="updateUsername()">Save</button>
      </div>
    </aside>

    <main class="main">
      <div id="messages"></div>

      <div id="new-message">
        <input type="text" id="message-input" placeholder="Type your message..." />
        <button id="upload-btn">
          üìé
          <input type="file" id="file-input" accept="image/*">
        </button>
        <button id="send-btn" onclick="sendMessage()">Send</button>
      </div>
    </main>
  </div>

  <footer>
    3DVR.Tech &copy; 2025 - Open Web for Everyone | Visit <a href="https://3dvr.tech">3DVR.Tech</a> | <a href="https://github.com/tmsteph/3dvr-portal">Contribute on GitHub</a>
  </footer>

  <script>
    const gun = Gun([
      'https://gun-relay-3dvr.fly.dev/gun',
      'https://gun-manhattan.herokuapp.com/gun'
    ]);
    let currentRoom = 'general';
    let chat = gun.get('3dvr-chat').get(currentRoom);

    const userId = localStorage.getItem('userId') || (() => {
      const id = 'user_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('userId', id);
      return id;
    })();
    const user = gun.get('3dvr-users').get(userId);

    // Migrar mensajes antiguos al nuevo esquema
    if (currentRoom === 'general') {
      gun.get('3dvr-chat').map().once((data, id) => {
        if (!data || data.migrated) return;
        const room = data.room || 'general';
        gun.get('3dvr-chat').get(room).get(id).put({ ...data, migrated: true });
      });
    }

    function updateUsername() {
      const name = document.getElementById('new-username').value.trim();
      if (name && name.length <= 32) {
        user.get('username').put(name);
        document.getElementById('new-username').value = '';
      }
    }

    user.get('username').on(name => {
      if (name) {
        document.getElementById('current-username').textContent = name;
      }
    });

    function sendMessage(text = null, attachment = null) {
      const input = document.getElementById('message-input');
      const msgText = text || input.value.trim();
      if (!msgText && !attachment) return;

      const message = {
        text: msgText,
        sender: userId,
        createdAt: Date.now(),
        attachment: attachment || null
      };

      chat.set(message);

      if (input) input.value = '';

      // Puntos por mensaje
      user.get('score').once(currentScore => {
        user.get('score').put((currentScore || 0) + 1);
      });
    }

    const messages = {};

    function timeAgo(timestamp) {
      const now = Date.now();
      const diff = Math.floor((now - timestamp) / 1000);
      if (diff < 60) return `${diff}s ago`;
      const mins = Math.floor(diff / 60);
      if (mins < 60) return `${mins}m ago`;
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return `${hrs}h ago`;
      const date = new Date(timestamp);
      return date.toLocaleString(undefined, { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
    }

    function displayMessages() {
      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML = '';

      const sorted = Object.entries(messages)
        .sort(([, a], [, b]) => (b.createdAt || 0) - (a.createdAt || 0));

      sorted.forEach(([, message]) => {
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${message.sender === userId ? 'sent' : ''}`;

        const username = message.username || 'Anonymous';
        const time = message.createdAt ? timeAgo(message.createdAt) : '';

        msgDiv.innerHTML = `<strong>${username}:</strong> ${message.text ? message.text : ''}`;

        if (message.attachment) {
          const img = document.createElement('div');
          img.className = 'attachment';
          img.innerHTML = `<img src="${message.attachment}" alt="Shared image">`;
          msgDiv.appendChild(img);
        }

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = time;
        msgDiv.appendChild(meta);

        messagesDiv.appendChild(msgDiv);
      });
    }

    function loadRoom(roomName) {
      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML = '';
      Object.keys(messages).forEach(key => delete messages[key]);

      chat = gun.get('3dvr-chat').get(roomName);
      chat.map().on((data, id) => {
        if (!data || messages[id]) return;

        messages[id] = { ...data };

        gun.get('3dvr-users').get(data.sender).get('username').once(name => {
          messages[id].username = name || 'User';
          displayMessages();
        });
      });
    }

    function changeRoom() {
      currentRoom = document.getElementById('room').value;
      loadRoom(currentRoom);
    }

    // Enviar con Enter
    document.getElementById('message-input').addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Subir imagen
    document.getElementById('file-input').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file || !file.type.startsWith('image/')) return;

      const reader = new FileReader();
      reader.onload = () => {
        sendMessage(`üìé Sent an image`, reader.result);
        document.getElementById('file-input').value = '';
      };
      reader.readAsDataURL(file);
    });

    // Inicializar
    loadRoom(currentRoom);
  </script>
</body>
</html>